From 184032ac4357428056ee30aebbeded53dcc1cb84 Mon Sep 17 00:00:00 2001
From: Hongxu Jia <hongxu.jia@windriver.com>
Date: Tue, 12 Sep 2023 11:39:04 +0800
Subject: [PATCH] Add support for posix_devctl()

It is defined in POSIX 1003.26 and required by the FACE Technical
Standard.

POSIX 1003.26 is available from here:
https://standards.ieee.org/findstds/standard/1003.26-2003.html

Implement FACE 3.0 specific details, as documented in Section 3.2.1.2, GPSS
POSIX numbers 10 and 11, see:
http://oaevents.goprecise.com/wp-content/uploads/2017/11/FACE-Technical-Standard-Edition-3.0.pdf

Upstream-Status: Pending

Signed-off-by: Hongxu Jia <hongxu.jia@windriver.com>
---
 bits/confname.h                               |   2 +
 posix/Makefile                                |   2 +
 posix/Versions                                |   5 +
 posix/devctl.h                                |  51 ++++++++
 posix/getconf.c                               |   2 +
 posix/posix_devctl.c                          |  31 +++++
 posix/sysconf.c                               |   7 ++
 posix/unistd.h                                |   4 +
 sysdeps/mach/hurd/i386/libc.abilist           |   1 +
 sysdeps/unix/sysv/linux/aarch64/libc.abilist  |   1 +
 sysdeps/unix/sysv/linux/alpha/libc.abilist    |   1 +
 sysdeps/unix/sysv/linux/arm/be/libc.abilist   |   1 +
 sysdeps/unix/sysv/linux/arm/le/libc.abilist   |   1 +
 sysdeps/unix/sysv/linux/csky/libc.abilist     |   1 +
 sysdeps/unix/sysv/linux/hppa/libc.abilist     |   1 +
 sysdeps/unix/sysv/linux/i386/libc.abilist     |   1 +
 sysdeps/unix/sysv/linux/ia64/libc.abilist     |   1 +
 .../sysv/linux/m68k/coldfire/libc.abilist     |   1 +
 .../unix/sysv/linux/m68k/m680x0/libc.abilist  |   1 +
 .../sysv/linux/microblaze/be/libc.abilist     |   1 +
 .../sysv/linux/microblaze/le/libc.abilist     |   1 +
 .../sysv/linux/mips/mips32/fpu/libc.abilist   |   1 +
 .../sysv/linux/mips/mips32/nofpu/libc.abilist |   1 +
 .../sysv/linux/mips/mips64/n32/libc.abilist   |   1 +
 .../sysv/linux/mips/mips64/n64/libc.abilist   |   1 +
 sysdeps/unix/sysv/linux/nios2/libc.abilist    |   1 +
 sysdeps/unix/sysv/linux/posix_devctl.c        | 116 ++++++++++++++++++
 .../linux/powerpc/powerpc32/fpu/libc.abilist  |   1 +
 .../powerpc/powerpc32/nofpu/libc.abilist      |   1 +
 .../linux/powerpc/powerpc64/be/libc.abilist   |   1 +
 .../linux/powerpc/powerpc64/le/libc.abilist   |   1 +
 .../unix/sysv/linux/riscv/rv64/libc.abilist   |   1 +
 .../unix/sysv/linux/s390/s390-32/libc.abilist |   1 +
 .../unix/sysv/linux/s390/s390-64/libc.abilist |   1 +
 sysdeps/unix/sysv/linux/sh/be/libc.abilist    |   1 +
 sysdeps/unix/sysv/linux/sh/le/libc.abilist    |   1 +
 .../sysv/linux/sparc/sparc32/libc.abilist     |   1 +
 .../sysv/linux/sparc/sparc64/libc.abilist     |   1 +
 .../unix/sysv/linux/x86_64/64/libc.abilist    |   1 +
 .../unix/sysv/linux/x86_64/x32/libc.abilist   |   1 +
 40 files changed, 251 insertions(+)
 create mode 100644 posix/devctl.h
 create mode 100644 posix/posix_devctl.c
 create mode 100644 sysdeps/unix/sysv/linux/posix_devctl.c

diff --git a/bits/confname.h b/bits/confname.h
index d6142640c3..3b1d314569 100644
--- a/bits/confname.h
+++ b/bits/confname.h
@@ -492,6 +492,8 @@ enum
 #define _SC_LEVEL4_CACHE_ASSOC		_SC_LEVEL4_CACHE_ASSOC
     _SC_LEVEL4_CACHE_LINESIZE,
 #define _SC_LEVEL4_CACHE_LINESIZE	_SC_LEVEL4_CACHE_LINESIZE
+    _SC_POSIX_26_VERSION,
+#define _SC_POSIX_26_VERSION		_SC_POSIX_26_VERSION
     /* Leave room here, maybe we need a few more cache levels some day.  */
 
     _SC_IPV6 = _SC_LEVEL1_ICACHE_SIZE + 50,
diff --git a/posix/Makefile b/posix/Makefile
index 3d368b91f6..89821e1b5d 100644
--- a/posix/Makefile
+++ b/posix/Makefile
@@ -50,6 +50,7 @@ headers := \
   bits/waitstatus.h \
   cpio.h \
   fnmatch.h \
+  devctl.h \
   getopt.h \
   glob.h \
   re_comp.h \
@@ -116,6 +117,7 @@ routines := \
   pathconf \
   pause \
   posix_madvise \
+  posix_devctl \
   pread \
   pread64 \
   pwrite \
diff --git a/posix/Versions b/posix/Versions
index 3753810864..9315695718 100644
--- a/posix/Versions
+++ b/posix/Versions
@@ -159,6 +159,11 @@ libc {
   GLIBC_2.35 {
     posix_spawn_file_actions_addtcsetpgrp_np;
   }
+
+  GLIBC_2.28 {
+    posix_devctl;
+  }
+
   GLIBC_PRIVATE {
     __libc_fork; __libc_pread; __libc_pwrite;
     __nanosleep_nocancel; __pause_nocancel;
diff --git a/posix/devctl.h b/posix/devctl.h
new file mode 100644
index 0000000000..1010035a26
--- /dev/null
+++ b/posix/devctl.h
@@ -0,0 +1,51 @@
+/* Definitions for POSIX posix_devctl interface.
+   Copyright (C) 2014-2019 Wind River Systems, Inc.
+
+   The GNU C Library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Lesser General Public
+   License as published by the Free Software Foundation; either
+   version 2.1 of the License, or (at your option) any later version.
+
+   The GNU C Library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+   Lesser General Public License for more details.
+
+   You should have received a copy of the GNU Lesser General Public
+   License along with the GNU C Library; if not, see
+   <http://www.gnu.org/licenses/>. */
+
+#ifndef _DEVCTL_H
+#define _DEVCTL_H
+
+#include <unistd.h>
+/*
+ * posix_devctl() is defined by POSIX 1003.26-2003. It requires
+ * POSIX_26_C_SOURCE to be defined in order for the function to
+ * be available.
+ */
+#if _POSIX_26_C_SOURCE == 200312L
+
+#include <sys/ioctl.h>
+#include <sys/types.h>
+
+/* http://oaevents.goprecise.com/wp-content/uploads/2017/11/FACE-Technical-Standard-Edition-3.0.pdf
+ * Implement FACE 3.0 specific details, as documented in Section 3.2.1.2, GPSS
+ * POSIX numbers 10 and 11, see:
+ * An OSS UoC shall define:
+ * a. A macro in <sys/ioctl.h> named FIONBIO to configure sockets for non-blocking I/O
+ * b. A macro in <devctl.h> named SOCKCLOSE to close an open socket
+ * Use `_IOR' to define SOCKCLOSE that avoids macro conflict with <sys/ioctl.h>
+ */
+#define SOCKCLOSE    _IOR('f', 200, int)
+
+__BEGIN_DECLS
+extern int posix_devctl(int fildes,
+                        int dcmd,
+                        void *__restrict dev_data_ptr,
+                        size_t nbyte,
+                        int *__restrict dev_info_ptr);
+__END_DECLS
+
+#endif /* _POSIX_26_C_SOURCE == 200312L */
+#endif /* _DEVCTL_H */
diff --git a/posix/getconf.c b/posix/getconf.c
index 60248f856e..091f3e83d9 100644
--- a/posix/getconf.c
+++ b/posix/getconf.c
@@ -403,6 +403,8 @@ static const struct conf vars[] =
     { "_POSIX_IPV6", _SC_IPV6, SYSCONF },
     { "_POSIX_RAW_SOCKETS", _SC_RAW_SOCKETS, SYSCONF },
 
+    { "_POSIX_26_VERSION", _SC_POSIX_26_VERSION, SYSCONF },
+
     { NULL, 0, SYSCONF }
   };
 
diff --git a/posix/posix_devctl.c b/posix/posix_devctl.c
new file mode 100644
index 0000000000..a002274bf0
--- /dev/null
+++ b/posix/posix_devctl.c
@@ -0,0 +1,31 @@
+/* Copyright (C) 2019 Wind River Systems, Inc.
+
+   The GNU C Library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Lesser General Public
+   License as published by the Free Software Foundation; either
+   version 2.1 of the License, or (at your option) any later version.
+
+   The GNU C Library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+   Lesser General Public License for more details.
+
+   You should have received a copy of the GNU Lesser General Public
+   License along with the GNU C Library; if not, see
+   <http://www.gnu.org/licenses/>. */
+
+#include <devctl.h>
+#include <errno.h>
+
+/* The posix_devctl method is defined by POSIX 1003.26-2003.
+   The interface can simply pass the arguments to the regular system ioctl. */
+
+int posix_devctl(int fildes,
+                 int dcmd,
+                 void *__restrict dev_data_ptr,
+                 size_t nbyte,
+                 int *__restrict dev_info_ptr)
+{
+    return ENOSYS;
+}
+stub_warning (posix_devctl)
diff --git a/posix/sysconf.c b/posix/sysconf.c
index 0bedc1e3e4..cebc4d87c6 100644
--- a/posix/sysconf.c
+++ b/posix/sysconf.c
@@ -148,6 +148,13 @@ __sysconf (int name)
     case _SC_GETPW_R_SIZE_MAX:
       return NSS_BUFLEN_PASSWD;
 
+    case _SC_POSIX_26_VERSION:
+#ifdef _POSIX_26_C_SOURCE
+      return _POSIX_26_VERSION;
+#else
+      return -1;
+#endif
+
     case _SC_ARG_MAX:
     case _SC_CHILD_MAX:
     case _SC_CLK_TCK:
diff --git a/posix/unistd.h b/posix/unistd.h
index 0477527a60..31af331970 100644
--- a/posix/unistd.h
+++ b/posix/unistd.h
@@ -85,6 +85,10 @@ __BEGIN_DECLS
    creation of locales with the localedef utility.  */
 #define _POSIX2_LOCALEDEF       __POSIX2_THIS_VERSION
 
+/* If defined, the implementation supports the
+   implement posix_devctl() using ioctl()  */
+#define _POSIX_26_C_SOURCE 200312L
+
 /* X/Open version number to which the library conforms.  It is selectable.  */
 #ifdef __USE_XOPEN2K8
 # define _XOPEN_VERSION	700
diff --git a/sysdeps/mach/hurd/i386/libc.abilist b/sysdeps/mach/hurd/i386/libc.abilist
index 74a9f427b2..081eb390ba 100644
--- a/sysdeps/mach/hurd/i386/libc.abilist
+++ b/sysdeps/mach/hurd/i386/libc.abilist
@@ -2071,6 +2071,7 @@ GLIBC_2.27 wcstof64x F
 GLIBC_2.27 wcstof64x_l F
 GLIBC_2.28 fcntl64 F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.29 _hurd_port_move F
 GLIBC_2.29 posix_spawn_file_actions_addchdir_np F
diff --git a/sysdeps/unix/sysv/linux/aarch64/libc.abilist b/sysdeps/unix/sysv/linux/aarch64/libc.abilist
index c49363e70e..2e510dd17f 100644
--- a/sysdeps/unix/sysv/linux/aarch64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/aarch64/libc.abilist
@@ -2353,6 +2353,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/alpha/libc.abilist b/sysdeps/unix/sysv/linux/alpha/libc.abilist
index d6b1dcaae6..c1d2d08aaf 100644
--- a/sysdeps/unix/sysv/linux/alpha/libc.abilist
+++ b/sysdeps/unix/sysv/linux/alpha/libc.abilist
@@ -2228,6 +2228,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/arm/be/libc.abilist b/sysdeps/unix/sysv/linux/arm/be/libc.abilist
index 6c75e5aa76..1af6d5f312 100644
--- a/sysdeps/unix/sysv/linux/arm/be/libc.abilist
+++ b/sysdeps/unix/sysv/linux/arm/be/libc.abilist
@@ -139,6 +139,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/arm/le/libc.abilist b/sysdeps/unix/sysv/linux/arm/le/libc.abilist
index 03d6f7ae2d..b0c2800f50 100644
--- a/sysdeps/unix/sysv/linux/arm/le/libc.abilist
+++ b/sysdeps/unix/sysv/linux/arm/le/libc.abilist
@@ -139,6 +139,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/csky/libc.abilist b/sysdeps/unix/sysv/linux/csky/libc.abilist
index d858c108c6..a4407a29f3 100644
--- a/sysdeps/unix/sysv/linux/csky/libc.abilist
+++ b/sysdeps/unix/sysv/linux/csky/libc.abilist
@@ -1729,6 +1729,7 @@ GLIBC_2.29 remque F
 GLIBC_2.29 rename F
 GLIBC_2.29 renameat F
 GLIBC_2.29 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.29 revoke F
 GLIBC_2.29 rewind F
 GLIBC_2.29 rewinddir F
diff --git a/sysdeps/unix/sysv/linux/hppa/libc.abilist b/sysdeps/unix/sysv/linux/hppa/libc.abilist
index 82a14f8ace..6063ed3ec2 100644
--- a/sysdeps/unix/sysv/linux/hppa/libc.abilist
+++ b/sysdeps/unix/sysv/linux/hppa/libc.abilist
@@ -2060,6 +2060,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/i386/libc.abilist b/sysdeps/unix/sysv/linux/i386/libc.abilist
index 1950b15d5d..6029779181 100644
--- a/sysdeps/unix/sysv/linux/i386/libc.abilist
+++ b/sysdeps/unix/sysv/linux/i386/libc.abilist
@@ -2241,6 +2241,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/ia64/libc.abilist b/sysdeps/unix/sysv/linux/ia64/libc.abilist
index d0b9cb279b..465778e6c1 100644
--- a/sysdeps/unix/sysv/linux/ia64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/ia64/libc.abilist
@@ -2095,6 +2095,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/m68k/coldfire/libc.abilist b/sysdeps/unix/sysv/linux/m68k/coldfire/libc.abilist
index 35785a3d5f..d76ba25a1e 100644
--- a/sysdeps/unix/sysv/linux/m68k/coldfire/libc.abilist
+++ b/sysdeps/unix/sysv/linux/m68k/coldfire/libc.abilist
@@ -140,6 +140,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/m68k/m680x0/libc.abilist b/sysdeps/unix/sysv/linux/m68k/m680x0/libc.abilist
index 4ab2426e0a..90881c6abb 100644
--- a/sysdeps/unix/sysv/linux/m68k/m680x0/libc.abilist
+++ b/sysdeps/unix/sysv/linux/m68k/m680x0/libc.abilist
@@ -2184,6 +2184,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/microblaze/be/libc.abilist b/sysdeps/unix/sysv/linux/microblaze/be/libc.abilist
index 38faa16232..5aead0d0b9 100644
--- a/sysdeps/unix/sysv/linux/microblaze/be/libc.abilist
+++ b/sysdeps/unix/sysv/linux/microblaze/be/libc.abilist
@@ -2344,6 +2344,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/microblaze/le/libc.abilist b/sysdeps/unix/sysv/linux/microblaze/le/libc.abilist
index 374d658988..fc6dece668 100644
--- a/sysdeps/unix/sysv/linux/microblaze/le/libc.abilist
+++ b/sysdeps/unix/sysv/linux/microblaze/le/libc.abilist
@@ -2344,6 +2344,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/mips/mips32/fpu/libc.abilist b/sysdeps/unix/sysv/linux/mips/mips32/fpu/libc.abilist
index fcc5e88e91..9d5bca8621 100644
--- a/sysdeps/unix/sysv/linux/mips/mips32/fpu/libc.abilist
+++ b/sysdeps/unix/sysv/linux/mips/mips32/fpu/libc.abilist
@@ -2154,6 +2154,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/mips/mips32/nofpu/libc.abilist b/sysdeps/unix/sysv/linux/mips/mips32/nofpu/libc.abilist
index 01eb96cd93..215428733d 100644
--- a/sysdeps/unix/sysv/linux/mips/mips32/nofpu/libc.abilist
+++ b/sysdeps/unix/sysv/linux/mips/mips32/nofpu/libc.abilist
@@ -2152,6 +2152,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/mips/mips64/n32/libc.abilist b/sysdeps/unix/sysv/linux/mips/mips64/n32/libc.abilist
index a2748b7b74..cad06fe252 100644
--- a/sysdeps/unix/sysv/linux/mips/mips64/n32/libc.abilist
+++ b/sysdeps/unix/sysv/linux/mips/mips64/n32/libc.abilist
@@ -2160,6 +2160,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/mips/mips64/n64/libc.abilist b/sysdeps/unix/sysv/linux/mips/mips64/n64/libc.abilist
index 0ae7ba499d..be36810981 100644
--- a/sysdeps/unix/sysv/linux/mips/mips64/n64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/mips/mips64/n64/libc.abilist
@@ -2155,6 +2155,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/nios2/libc.abilist b/sysdeps/unix/sysv/linux/nios2/libc.abilist
index 947495a0e2..b52340f586 100644
--- a/sysdeps/unix/sysv/linux/nios2/libc.abilist
+++ b/sysdeps/unix/sysv/linux/nios2/libc.abilist
@@ -2386,6 +2386,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/posix_devctl.c b/sysdeps/unix/sysv/linux/posix_devctl.c
new file mode 100644
index 0000000000..2fd7ae61a8
--- /dev/null
+++ b/sysdeps/unix/sysv/linux/posix_devctl.c
@@ -0,0 +1,116 @@
+/* Define the posix_devctl.c function.
+   Copyright (C) 2014-2019 Wind River Systems, Inc.
+
+   The GNU C Library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Lesser General Public
+   License as published by the Free Software Foundation; either
+   version 2.1 of the License, or (at your option) any later version.
+
+   The GNU C Library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+   Lesser General Public License for more details.
+
+   You should have received a copy of the GNU Lesser General Public
+   License along with the GNU C Library; if not, see
+   <http://www.gnu.org/licenses/>. */
+
+#include <devctl.h>
+#include <errno.h>
+
+/* The posix_devctl method is defined by POSIX 1003.26-2003.
+   The interface can simply pass the arguments to the regular system ioctl. */
+
+int posix_devctl(int fildes,
+                 int dcmd,
+                 void *__restrict dev_data_ptr,
+                 size_t nbyte,
+                 int *__restrict dev_info_ptr)
+{
+  /* POSIX 1003.26-2003 indicates that there is a "general goal
+   * of being able to implement posix_devctl() using the existing
+   * ioctl() interfaces provided in current UNIX systems and other
+   * POSIX implementations because the standard allows but does not
+   * require checking the size of the device data."
+   *
+   * As such this function will be implemented primarily using the
+   * existing ioctl() interface as permitted by the specification.
+   *
+   * Additionally the FACE Technical Standard 3.0, Section 3.2.1.2,
+   * requiret that FIONBIO and SOCKCLOSE command be supported.
+   */
+
+  int ret = 0;
+  __set_errno (0);
+
+  if (fildes < 0)
+  {
+    __set_errno (EBADF);
+    ret = -1;
+    goto on_error;
+  }
+
+  if (nbyte > 0 && dev_data_ptr == NULL)
+  {
+    __set_errno (EINVAL);
+    ret = -1;
+    goto on_error;
+  }
+
+  /* An OSS UoC shall provide:
+   * a. The SOCKCLOSE command in the posix_devctl() API
+   * b. The FIONBIO command in the posix_devctl() API
+   */
+  switch (dcmd)
+    {
+    case SOCKCLOSE:
+      if (nbyte > 0 || dev_data_ptr != NULL)
+      {
+        __set_errno (EINVAL);
+        ret = -1;
+        goto on_error;
+      }
+      ret = close(fildes);
+      break;
+    // FIONBIO is implemented in kernel
+    case FIONBIO:
+      if ((nbyte > 0 && nbyte < sizeof(int)) ||
+          dev_data_ptr == NULL)
+      {
+        __set_errno (EINVAL);
+        ret = -1;
+        goto on_error;
+      }
+    default:
+      ret = __ioctl(fildes, dcmd, dev_data_ptr);
+    }
+
+
+on_error:
+  /* ioctl() and posix_devctl() have different return value semantics.
+   *
+   * (from the Linux man-pages project)
+   * ioctl() will usually return success with zero, but a few ioctl() request use
+   * the return value as an output parameter and return a nonnegative value on
+   * success.  On error, -1 is returned, and errno is set appropriately.
+   *
+   * post_devctl(), upon successful completion, shall return zero; otherwise an
+   * error number shall be returned to indicate the error. The value returned via
+   * the dev_info_ptr argument is driver dependent.
+   *
+   * Based on this it can be assumed an ioctl() return value of -1 indicates
+   * an error, and the error number will be set in errno.
+   *
+   * Any nonnegative value returned is then considered to indicate success,
+   * and assumed to be an output parameter from ioctl().  Output parameters are
+   * transferred into dev_info_ptr, unless it is NULL.
+   */
+  if (dev_info_ptr != NULL) {
+      *dev_info_ptr = ret;
+  }
+
+  if (ret < 0)
+    ret = errno;
+
+  return ret;
+}
diff --git a/sysdeps/unix/sysv/linux/powerpc/powerpc32/fpu/libc.abilist b/sysdeps/unix/sysv/linux/powerpc/powerpc32/fpu/libc.abilist
index 19c4c325b0..e6ae9efe15 100644
--- a/sysdeps/unix/sysv/linux/powerpc/powerpc32/fpu/libc.abilist
+++ b/sysdeps/unix/sysv/linux/powerpc/powerpc32/fpu/libc.abilist
@@ -2188,6 +2188,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/powerpc/powerpc32/nofpu/libc.abilist b/sysdeps/unix/sysv/linux/powerpc/powerpc32/nofpu/libc.abilist
index 3e043c4044..4aea2d3cea 100644
--- a/sysdeps/unix/sysv/linux/powerpc/powerpc32/nofpu/libc.abilist
+++ b/sysdeps/unix/sysv/linux/powerpc/powerpc32/nofpu/libc.abilist
@@ -2192,6 +2192,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/powerpc/powerpc64/be/libc.abilist b/sysdeps/unix/sysv/linux/powerpc/powerpc64/be/libc.abilist
index e4f3a766bb..49c5124f96 100644
--- a/sysdeps/unix/sysv/linux/powerpc/powerpc64/be/libc.abilist
+++ b/sysdeps/unix/sysv/linux/powerpc/powerpc64/be/libc.abilist
@@ -139,6 +139,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/powerpc/powerpc64/le/libc.abilist b/sysdeps/unix/sysv/linux/powerpc/powerpc64/le/libc.abilist
index dafe1c4a59..c97ec3a9ee 100644
--- a/sysdeps/unix/sysv/linux/powerpc/powerpc64/le/libc.abilist
+++ b/sysdeps/unix/sysv/linux/powerpc/powerpc64/le/libc.abilist
@@ -2443,6 +2443,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/riscv/rv64/libc.abilist b/sysdeps/unix/sysv/linux/riscv/rv64/libc.abilist
index e3b4656aa2..40be5c7a11 100644
--- a/sysdeps/unix/sysv/linux/riscv/rv64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/riscv/rv64/libc.abilist
@@ -2316,6 +2316,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/s390/s390-32/libc.abilist b/sysdeps/unix/sysv/linux/s390/s390-32/libc.abilist
index 84cb7a50ed..6c74a90af7 100644
--- a/sysdeps/unix/sysv/linux/s390/s390-32/libc.abilist
+++ b/sysdeps/unix/sysv/linux/s390/s390-32/libc.abilist
@@ -2197,6 +2197,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/s390/s390-64/libc.abilist b/sysdeps/unix/sysv/linux/s390/s390-64/libc.abilist
index 33df3b1646..5c5c7f5bd4 100644
--- a/sysdeps/unix/sysv/linux/s390/s390-64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/s390/s390-64/libc.abilist
@@ -2081,6 +2081,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/sh/be/libc.abilist b/sysdeps/unix/sysv/linux/sh/be/libc.abilist
index 94cbccd715..f5bffca2a7 100644
--- a/sysdeps/unix/sysv/linux/sh/be/libc.abilist
+++ b/sysdeps/unix/sysv/linux/sh/be/libc.abilist
@@ -2064,6 +2064,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/sh/le/libc.abilist b/sysdeps/unix/sysv/linux/sh/le/libc.abilist
index 3bb316a787..743972e661 100644
--- a/sysdeps/unix/sysv/linux/sh/le/libc.abilist
+++ b/sysdeps/unix/sysv/linux/sh/le/libc.abilist
@@ -2064,6 +2064,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/sparc/sparc32/libc.abilist b/sysdeps/unix/sysv/linux/sparc/sparc32/libc.abilist
index 6341b491b4..3ecd1a6144 100644
--- a/sysdeps/unix/sysv/linux/sparc/sparc32/libc.abilist
+++ b/sysdeps/unix/sysv/linux/sparc/sparc32/libc.abilist
@@ -2191,6 +2191,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/sparc/sparc64/libc.abilist b/sysdeps/unix/sysv/linux/sparc/sparc64/libc.abilist
index 8ed1ea2926..c65542dd7b 100644
--- a/sysdeps/unix/sysv/linux/sparc/sparc64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/sparc/sparc64/libc.abilist
@@ -2117,6 +2117,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/x86_64/64/libc.abilist b/sysdeps/unix/sysv/linux/x86_64/64/libc.abilist
index 57cfcc2086..b0fe6bfa8d 100644
--- a/sysdeps/unix/sysv/linux/x86_64/64/libc.abilist
+++ b/sysdeps/unix/sysv/linux/x86_64/64/libc.abilist
@@ -2070,6 +2070,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
diff --git a/sysdeps/unix/sysv/linux/x86_64/x32/libc.abilist b/sysdeps/unix/sysv/linux/x86_64/x32/libc.abilist
index 3f0a9f6d82..e6f9fde49c 100644
--- a/sysdeps/unix/sysv/linux/x86_64/x32/libc.abilist
+++ b/sysdeps/unix/sysv/linux/x86_64/x32/libc.abilist
@@ -2366,6 +2366,7 @@ GLIBC_2.28 mtx_timedlock F
 GLIBC_2.28 mtx_trylock F
 GLIBC_2.28 mtx_unlock F
 GLIBC_2.28 renameat2 F
+GLIBC_2.28 posix_devctl F
 GLIBC_2.28 statx F
 GLIBC_2.28 thrd_create F
 GLIBC_2.28 thrd_current F
-- 
2.27.0

