From 64e89029b869a6e857ff3cf06126c77f4fa07b6c Mon Sep 17 00:00:00 2001
From: Yi Zhao <yi.zhao@windriver.com>
Date: Fri, 2 Sep 2022 18:08:12 +0800
Subject: [PATCH] Enable password_quality rules

Upstream-Status: Inappropriate [WRLinux specific]

Signed-off-by: Yi Zhao <yi.zhao@windriver.com>
---
 .../accounts_password_pam_retry/bash/wrlinux.sh    |  5 +++++
 .../accounts_password_pam_retry/oval/shared.xml    |  2 +-
 .../accounts_password_pam_retry/rule.yml           |  6 +++---
 .../oval/accounts_password_pam_pwquality.xml       | 14 +++++++++++++-
 shared/templates/accounts_password/bash.template   |  4 +++-
 5 files changed, 25 insertions(+), 6 deletions(-)
 create mode 100644 linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/bash/wrlinux.sh

diff --git a/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/bash/wrlinux.sh b/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/bash/wrlinux.sh
new file mode 100644
index 0000000000..beea5490d0
--- /dev/null
+++ b/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/bash/wrlinux.sh
@@ -0,0 +1,5 @@
+# platform = multi_platform_wrlinux
+
+{{{ bash_instantiate_variables("var_password_pam_retry") }}}
+
+{{{ bash_ensure_pam_module_options('/etc/pam.d/common-password', 'password', 'requisite', 'pam_pwquality.so', 'retry', "$var_password_pam_retry", "$var_password_pam_retry") }}}
diff --git a/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/oval/shared.xml b/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/oval/shared.xml
index ee1f51d3d4..42bca22722 100644
--- a/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/oval/shared.xml
+++ b/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/oval/shared.xml
@@ -1,4 +1,4 @@
-{{% if 'ubuntu' in product %}}
+{{% if 'ubuntu' in product or 'wrlinux' in product %}}
 {{% set configuration_files = ["common-password"] %}}
 {{% elif product in ['ol8','ol9','rhel8', 'rhel9'] %}}
 {{% set configuration_files = ["password-auth","system-auth"] %}}
diff --git a/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/rule.yml b/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/rule.yml
index 411a67363a..9669f2f018 100644
--- a/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/rule.yml
+++ b/linux_os/guide/system/accounts/accounts-pam/password_quality/password_quality_pwquality/accounts_password_pam_retry/rule.yml
@@ -9,7 +9,7 @@ description: |-
     Edit the <tt>/etc/security/pwquality.conf</tt> to include
     {{% else %}}
     Edit the <tt>pam_pwquality.so</tt> statement in
-    {{% if 'ubuntu' not in product %}}
+    {{% if 'ubuntu' in product or 'wrlinux' in product %}}
     <tt>/etc/pam.d/system-auth</tt> to show
     {{% else %}}
     <tt>/etc/pam.d/common-password</tt> to show
@@ -63,7 +63,7 @@ ocil: |-
     <pre>$ grep retry /etc/security/pwquality.conf</pre>
     {{% else %}}
     Check for the use of the "pwquality" retry option in the PAM files with the following command:
-    {{% if 'ubuntu' in product %}}
+    {{% if 'ubuntu' in product or 'wrlinux' in product %}}
     <pre>$ grep pam_pwquality /etc/pam.d/common-password</pre>
     {{% else %}}
     <pre>$ grep pam_pwquality /etc/pam.d/system-auth</pre>
@@ -82,7 +82,7 @@ fixtext: |-
 
     retry={{{ xccdf_value("var_password_pam_retry") }}}
     {{% else %}}
-    {{% if 'ubuntu' in product %}}
+    {{% if 'ubuntu' in product or 'wrlinux' in product %}}
     Add the following line to the "/etc/pam.d/common-password" file (or modify the line to have the required value):
     {{% else %}}
     Add the following line to the "/etc/pam.d/system-auth" file (or modify the line to have the required value):
diff --git a/shared/checks/oval/accounts_password_pam_pwquality.xml b/shared/checks/oval/accounts_password_pam_pwquality.xml
index dd94f729ef..c71ae6131e 100644
--- a/shared/checks/oval/accounts_password_pam_pwquality.xml
+++ b/shared/checks/oval/accounts_password_pam_pwquality.xml
@@ -1,11 +1,19 @@
 <def-group>
   <definition class="compliance" id="accounts_password_pam_pwquality" version="1">
     <metadata>
+      {{% if 'wrlinux' in product %}}
+      <title>Check pam_pwquality Existence in common-password</title>
+      {{% else %}}
       <title>Check pam_pwquality Existence in system-auth</title>
+      {{% endif %}}
       <affected family="unix">
         <platform>multi_platform_all</platform>
       </affected>
+      {{% if 'wrlinux' in product %}}
+      <description>Check that pam_pwquality.so exists in common-password</description>
+      {{% else %}}
       <description>Check that pam_pwquality.so exists in system-auth</description>
+      {{% endif %}}
     </metadata>
     <criteria>
       <criterion comment="Conditions for pam_pwquality are satisfied"
@@ -13,7 +21,11 @@
     </criteria>
   </definition>
 
+  {{% if 'wrlinux' in product %}}
+  <ind:textfilecontent54_test check="all" comment="check the configuration of /etc/pam.d/common-password" id="test_password_pam_pwquality" version="1">
+  {{% else %}}
   <ind:textfilecontent54_test check="all" comment="check the configuration of /etc/pam.d/system-auth" id="test_password_pam_pwquality" version="1">
+  {{% endif %}}
     <ind:object object_ref="obj_password_pam_pwquality" />
   </ind:textfilecontent54_test>
 
@@ -24,7 +36,7 @@
   </ind:textfilecontent54_object>
 
   <constant_variable id="var_pam_pwquality_config_path" version="1" datatype="string" comment="correct path for pam_pwquality.so check">
-    {{% if 'ubuntu' in product or 'debian' in product %}}
+    {{% if 'ubuntu' in product or 'debian' in product or 'wrlinux' in product %}}
     <value>/etc/pam.d/common-password</value>
     {{% else %}}
     <value>/etc/pam.d/system-auth</value>
diff --git a/shared/templates/accounts_password/bash.template b/shared/templates/accounts_password/bash.template
index 46e98c1471..cf645a34fd 100644
--- a/shared/templates/accounts_password/bash.template
+++ b/shared/templates/accounts_password/bash.template
@@ -1,9 +1,11 @@
-# platform = multi_platform_rhel,multi_platform_fedora,multi_platform_ol,multi_platform_rhv,multi_platform_ubuntu,multi_platform_sle
+# platform = multi_platform_rhel,multi_platform_fedora,multi_platform_ol,multi_platform_rhv,multi_platform_ubuntu,multi_platform_sle,multi_platform_wrlinux
 # reboot = false
 # strategy = restrict
 # complexity = low
 # disruption = low
 
+{{{ bash_ensure_pam_module_options('/etc/pam.d/common-password', 'password', 'requisite', 'pam_pwquality.so', '', '', '') }}}
+
 {{{ bash_instantiate_variables("var_password_pam_" ~ VARIABLE) }}}
 
 {{% if product == "ol8" %}}
-- 
2.25.1

