From f918e2c6ccc593b947c91267278df1112ec2b1a2 Mon Sep 17 00:00:00 2001
From: Yi Zhao <yi.zhao@windriver.com>
Date: Tue, 4 Aug 2020 13:19:35 +0800
Subject: [PATCH] policy/modules/system/userdomain: allow domain read home link
 directory

Fixes:
avc:  denied  { read } for  pid=453 comm="alsactl" name="root"
dev="sdb3" ino=1600 scontext=system_u:system_r:alsa_t:s0-s15:c0.c1023
tcontext=root:object_r:user_home_dir_t:s0 tclass=lnk_file permissive=0

avc:  denied  { read } for  pid=1494 comm="lpqd" name="root" dev="sdb3"
ino=1600 scontext=system_u:system_r:smbd_t:s0-s15:c0.c1023
tcontext=root:object_r:user_home_dir_t:s0 tclass=lnk_file permissive=0

Upstream-Status: Inappropriate [ostree specific]

Signed-off-by: Yi Zhao <yi.zhao@windriver.com>
---
 policy/modules/system/userdomain.if | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/policy/modules/system/userdomain.if b/policy/modules/system/userdomain.if
index 124ce4fa2..e692ee264 100644
--- a/policy/modules/system/userdomain.if
+++ b/policy/modules/system/userdomain.if
@@ -1790,6 +1790,7 @@ interface(`userdom_getattr_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir getattr_dir_perms;
 	files_search_home($1)
 ')
@@ -1827,6 +1828,7 @@ interface(`userdom_search_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -1872,6 +1874,7 @@ interface(`userdom_list_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir list_dir_perms;
 	files_search_home($1)
 ')
@@ -1909,6 +1912,7 @@ interface(`userdom_create_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir create_dir_perms;
 ')
 
@@ -1927,6 +1931,7 @@ interface(`userdom_manage_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir manage_dir_perms;
 ')
 
@@ -1964,6 +1969,7 @@ interface(`userdom_relabelto_user_home_dirs',`
 		type user_home_dir_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir relabelto;
 ')
 
@@ -2026,6 +2032,7 @@ interface(`userdom_user_home_domtrans',`
 	')
 
 	domain_auto_transition_pattern($1, user_home_t, $2)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2528,6 +2535,7 @@ interface(`userdom_manage_user_home_content_files',`
 	')
 
 	manage_files_pattern($1, user_home_t, user_home_t)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2568,6 +2576,7 @@ interface(`userdom_manage_user_home_content_symlinks',`
 	')
 
 	manage_lnk_files_pattern($1, user_home_t, user_home_t)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2627,6 +2636,7 @@ interface(`userdom_manage_user_home_content_pipes',`
 	')
 
 	manage_fifo_files_pattern($1, user_home_t, user_home_t)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -2647,6 +2657,7 @@ interface(`userdom_manage_user_home_content_sockets',`
 		type user_home_dir_t, user_home_t;
 	')
 
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	manage_sock_files_pattern($1, user_home_t, user_home_t)
 	files_search_home($1)
@@ -2684,6 +2695,7 @@ interface(`userdom_user_home_dir_filetrans',`
 		type user_home_dir_t;
 	')
 
+	read_lnk_files_pattern($1, user_home_dir_t, user_home_dir_t)
 	filetrans_pattern($1, user_home_dir_t, $2, $3, $4)
 	files_search_home($1)
 ')
@@ -2722,6 +2734,7 @@ interface(`userdom_user_home_content_filetrans',`
 	')
 
 	filetrans_pattern($1, user_home_t, $2, $3, $4)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 user_home_dir_t:dir search_dir_perms;
 	files_search_home($1)
 ')
@@ -4564,6 +4577,7 @@ interface(`userdom_search_user_home_content',`
 	')
 
 	files_list_home($1)
+	allow $1 user_home_dir_t:lnk_file read_lnk_file_perms;
 	allow $1 { user_home_dir_t user_home_t }:dir search_dir_perms;
 ')
 
-- 
2.25.1

